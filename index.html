<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>セットリスト</title>
    <link rel="stylesheet" href="style.css"/>
</head>
<body>

    <div class="header-container">
        <h2>セットリスト</h2>
        <button id="shareSetlistButton" onclick="shareSetlist()">共有</button>
        <button class="send-all-button" onclick="shareSetlist()">文字</button>
    </div>
    <div class="setlist-container">
        <ul id="setlist"></ul>
    </div>

<!-- ハンバーガーメニュー -->
<div class="menu-button" id="menuButton" onclick="toggleMenu()">
    <span></span>
    <span></span>
    <span></span>
</div>
<div class="menu" id="menu">
    <div class="close-button" onclick="toggleMenu()"></div> <!-- ✖ボタン -->
    
    <h3>アルバムを選択</h3>
    
    <!-- アルバムリスト -->
    <ul class="album-list">
        <li class="album1-tab" onclick="toggleAlbum(1)">SE・インスト</li>
        <ul class="album-content" id="album1">
            <li class="item album1" draggable="true">SE</li>
            <li class="item album1" draggable="true">MC</li>
            <li class="item album1" draggable="true">インスト</li>
            <li class="item album1" draggable="true">Drum’n SAX SE</li>
            <li class="item album1" draggable="true">Timeless</li>
            <li class="item album1" draggable="true">THE ONE</li>
            <li class="item album1" draggable="true">TYCOON</li>
            <li class="item album1" draggable="true">UNSER</li>
            <li class="item album1" draggable="true">NEVER ENDING WORLD</li>
            <li class="item album1" draggable="true">EYEWALL</li>
            <li class="item album1" draggable="true">ENIGMASIS</li>
            <li class="item album1" draggable="true">über cozy universe</li>
            <li class="item album1" draggable="true">和音 the stoic</li>
            <li class="item album1" draggable="true">over the stoic</li>
            <li class="item album1" draggable="true">Massive</li>
            <li class="item album1" draggable="true">CORE STREAM</li>
            <li class="item album1" draggable="true">Spreadown</li>
            <li class="item album1" draggable="true">to the world</li>
            <li class="item album1" draggable="true">ANOMALY奏者</li>
            <li class="item album1" draggable="true">Highlight!!</li>
        </ul>
    
        <li class="album2-tab" onclick="toggleAlbum(2)">Timeless</li>
        <ul class="album-content" id="album2">
            <li class="item album2" draggable="true">CHANCE!</li>
            <li class="item album2" draggable="true">トキノナミダ</li>
            <li class="item album2" draggable="true">Rush</li>
            <li class="item album2" draggable="true">D-tecnoLife</li>
            <li class="item album2" draggable="true">優しさの雫</li>
            <li class="item album2" draggable="true">ai ta 心</li>
            <li class="item album2" draggable="true">Burst</li>
            <li class="item album2" draggable="true">Nitro</li>
            <li class="item album2" draggable="true">just Melody</li>
            <li class="item album2" draggable="true">Lump Of Affection</li>
            <li class="item album2" draggable="true">扉</li>
        </ul>
    
        <li class="album3-tab" onclick="toggleAlbum(3)">BUGRIGHT</li>
        <ul class="album-content" id="album3">
            <li class="item album3" draggable="true">ゼロの答</li>
            <li class="item album3" draggable="true">SHAMROCK</li>
            <li class="item album3" draggable="true">Home 微熱39℃</li>
            <li class="item album3" draggable="true">〜流れ・空虚・THIS WORD〜</li>
            <li class="item album3" draggable="true">Colors of the Heart</li>
            <li class="item album3" draggable="true">Live everyday as if it were the last day</li>
            <li class="item album3" draggable="true">シャルマンノウラ</li>
            <li class="item album3" draggable="true">一人じゃないから</li>
            <li class="item album3" draggable="true">君の好きなうた</li>
            <li class="item album3" draggable="true">51%</li>
            <li class="item album3" draggable="true">LIFEsize</li>
            <li class="item album3" draggable="true">EMPTY96</li>
            <li class="item album3" draggable="true">DISCORD</li>
        </ul>
    
        <li class="album4-tab" onclick="toggleAlbum(4)">PROGLUTION</li>
        <ul class="album-content" id="album4">
            <li class="item album4" draggable="true">Roots</li>
            <li class="item album4" draggable="true">brand new ancient</li>
            <li class="item album4" draggable="true">浮世CROSSING</li>
            <li class="item album4" draggable="true">病的希求日記</li>
            <li class="item album4" draggable="true">counting song-H</li>
            <li class="item album4" draggable="true">シャカビーチ</li>
            <li class="item album4" draggable="true">GROOVY GROOVY GROOVY</li>
            <li class="item album4" draggable="true">expod-digital</li>
            <li class="item album4" draggable="true">UNKNOWN ORCHESTRA</li>
            <li class="item album4" draggable="true">神集め</li>
            <li class="item album4" draggable="true">ENERGY</li>
            <li class="item album4" draggable="true">endscape</li>
            <li class="item album4" draggable="true">心が指す場所と口癖そして君はついてくる</li>
            <li class="item album4" draggable="true">オトノハ</li>
        </ul>
    
        <li class="album5-tab" onclick="toggleAlbum(5)">AwakEVE</li>
        <ul class="album-content" id="album5">
            <li class="item album5" draggable="true">激動</li>
            <li class="item album5" draggable="true">99/100 騙しの哲</li>
            <li class="item album5" draggable="true">美影意志</li>
            <li class="item album5" draggable="true">コロナ</li>
            <li class="item album5" draggable="true">儚くも永久のカナシ</li>
            <li class="item album5" draggable="true">earthy world</li>
            <li class="item album5" draggable="true">畢生皐月プロローグ</li>
            <li class="item album5" draggable="true">アイ・アム Riri</li>
            <li class="item album5" draggable="true">恋いしくて</li>
            <li class="item album5" draggable="true">Forget</li>
            <li class="item album5" draggable="true">Just break the limit!</li>
            <li class="item album5" draggable="true">WAON THE STOIC</li>
            <li class="item album5" draggable="true">ハルジオン</li>
            <li class="item album5" draggable="true">YURAYURA</li>
        </ul>
    
        <li class="album6-tab" onclick="toggleAlbum(6)">LAST</li>
        <ul class="album-content" id="album6">
            <li class="item album6" draggable="true">GOLD</li>
            <li class="item album6" draggable="true">world LOST world</li>
            <li class="item album6" draggable="true">スパルタ</li>
            <li class="item album6" draggable="true">心とココロ</li>
            <li class="item album6" draggable="true">the truth</li>
            <li class="item album6" draggable="true">バーレル</li>
            <li class="item album6" draggable="true">ハイ!問題作</li>
            <li class="item album6" draggable="true">closed POKER</li>
            <li class="item album6" draggable="true">哀しみはきっと</li>
            <li class="item album6" draggable="true">CHANGE</li>
            <li class="item album6" draggable="true">WANNA be BLILLIANT</li>
            <li class="item album6" draggable="true">君のまま</li>
            <li class="item album6" draggable="true">GO-ON</li>
        </ul>
    
        <li class="album7-tab" onclick="toggleAlbum(7)">LIFE 6 SENCE</li>
        <ul class="album-content" id="album7">
            <li class="item album7" draggable="true">CORE PRIDE</li>
            <li class="item album7" draggable="true">いつか必ず死ぬことを忘れるな</li>
            <li class="item album7" draggable="true">一石を投じるTokyo Midnight Sun</li>
            <li class="item album7" draggable="true">ace of ace</li>
            <li class="item album7" draggable="true">NO.1</li>
            <li class="item album7" draggable="true">クオリア</li>
            <li class="item album7" draggable="true">シークレット</li>
            <li class="item album7" draggable="true">勝者臆病者</li>
            <li class="item album7" draggable="true">６つの風</li>
            <li class="item album7" draggable="true">一億分の一の小説</li>
            <li class="item album7" draggable="true">MONDO PIECE</li>
            <li class="item album7" draggable="true">白昼夢</li>
        </ul>
    
        <li class="album8-tab" onclick="toggleAlbum(8)">THE ONE</li>
        <ul class="album-content" id="album8">
            <li class="item album8" draggable="true">7th Trigger</li>
            <li class="item album8" draggable="true">Don't think feel</li>
            <li class="item album8" draggable="true">LIMITLESS</li>
            <li class="item album8" draggable="true">23ワード</li>
            <li class="item album8" draggable="true">KINJITO</li>
            <li class="item album8" draggable="true">THE OVER </li>
            <li class="item album8" draggable="true">此処から</li>
            <li class="item album8" draggable="true">REVERSI</li>
            <li class="item album8" draggable="true">バーベル</li>
            <li class="item album8" draggable="true">BABY BORN & GO</li>
            <li class="item album8" draggable="true">AWAYOKUBA-斬る</li>
            <li class="item album8" draggable="true">NOWHERE boy</li>
        </ul>
    
        <li class="album9-tab" onclick="toggleAlbum(9)">Ø choir</li>
        <ul class="album-content" id="album9">
            <li class="item album9" draggable="true">零HERE～SE～</li>
            <li class="item album9" draggable="true">IMPACT</li>
            <li class="item album9" draggable="true">誰が言った</li>
            <li class="item album9" draggable="true">ナノ・セカンド</li>
            <li class="item album9" draggable="true">Fight For Liberty</li>
            <li class="item album9" draggable="true">ENOUGH-1</li>
            <li class="item album9" draggable="true">Kickが自由</li>
            <li class="item album9" draggable="true">a LOVELY TONE</li>
            <li class="item album9" draggable="true">７日目の決意</li>
            <li class="item album9" draggable="true">別世界</li>
            <li class="item album9" draggable="true">Born Slippy</li>
            <li class="item album9" draggable="true">Wizard CLUB</li>
            <li class="item album9" draggable="true">在るべき形</li>
            <li class="item album9" draggable="true">Ø choir</li>
        </ul>
    
        <li class="album10-tab" onclick="toggleAlbum(10)">TYCOON</li>
        <ul class="album-content" id="album10">
            <li class="item album10" draggable="true">Q.E.D.</li>
            <li class="item album10" draggable="true">シリウス</li>
            <li class="item album10" draggable="true">SHOUT LOVE</li>
            <li class="item album10" draggable="true">IDEAL REALITY</li>
            <li class="item album10" draggable="true">LONE WOLF</li>
            <li class="item album10" draggable="true">DECIDED</li>
            <li class="item album10" draggable="true">PRAYING RUN</li>
            <li class="item album10" draggable="true">ALL ALONE</li>
            <li class="item album10" draggable="true">一滴の影響</li>
            <li class="item album10" draggable="true">ほんの少し</li>
            <li class="item album10" draggable="true">僕の言葉ではない これは僕たちの言葉</li>
            <li class="item album10" draggable="true">WE ARE GO</li>
            <li class="item album10" draggable="true">Collide</li>
            <li class="item album10" draggable="true">奏全域</li>
            <li class="item album10" draggable="true">I LOVE THE WORLD</li>
            <li class="item album10" draggable="true">エミュー</li>
            <li class="item album10" draggable="true">終焉</li>
        </ul>
    
        <li class="album11-tab" onclick="toggleAlbum(11)">UNSER</li>
        <ul class="album-content" id="album11">
            <li class="item album11" draggable="true">Making it Drive</li>
            <li class="item album11" draggable="true">AFTER LIFE</li>
            <li class="item album11" draggable="true">Touch off</li>
            <li class="item album11" draggable="true">境界</li>
            <li class="item album11" draggable="true">stay on</li>
            <li class="item album11" draggable="true">First Sight</li>
            <li class="item album11" draggable="true">ODD FUTURE</li>
            <li class="item album11" draggable="true">無意味になる夜</li>
            <li class="item album11" draggable="true">EDENへ</li>
            <li class="item album11" draggable="true">ConneQt</li>
            <li class="item album11" draggable="true">OXYMORON</li>
            <li class="item album11" draggable="true">One Last Time</li>
            <li class="item album11" draggable="true">ROB THE FRONTIER</li>
            <li class="item album11" draggable="true">GOOD and EVIL</li>
            <li class="item album11" draggable="true">UNSER (SE)</li>
        </ul>
    
        <li class="album12-tab" onclick="toggleAlbum(12)">30</li>
        <ul class="album-content" id="album12">
            <li class="item album12" draggable="true">EN</li>
            <li class="item album12" draggable="true">One stroke for freedom</li>
            <li class="item album12" draggable="true">えくぼ</li>
            <li class="item album12" draggable="true">OUR ALWAYS</li>
            <li class="item album12" draggable="true">AVALANCHE</li>
            <li class="item album12" draggable="true">THUG LIFE</li>
            <li class="item album12" draggable="true">SOUL</li>
            <li class="item album12" draggable="true">来鳥江</li>
            <li class="item album12" draggable="true">NAMELY</li>
            <li class="item album12" draggable="true">イーティー</li>
            <li class="item album12" draggable="true">AS ONE</li>
            <li class="item album12" draggable="true">HOURGLASS</li>
            <li class="item album12" draggable="true">NEVER ENDING WORLD</li>
        </ul>
    
        <li class="album13-tab" onclick="toggleAlbum(13)">ENIGMASIS</li>
        <ul class="album-content" id="album13">
            <li class="item album13" draggable="true">ビタースウィート</li>
            <li class="item album13" draggable="true">VICTOSPIN</li>
            <li class="item album13" draggable="true">ENCORE AGAIN</li>
            <li class="item album13" draggable="true">FINALIST</li>
            <li class="item album13" draggable="true">echoOZ</li>
            <li class="item album13" draggable="true">Don’t Think.Sing</li>
            <li class="item album13" draggable="true">α-Skill</li>
            <li class="item album13" draggable="true">two Lies</li>
            <li class="item album13" draggable="true">THEORY</li>
            <li class="item album13" draggable="true">ピグマリオン</li>
            <li class="item album13" draggable="true">ANOMALY奏者</li>
            <li class="item album13" draggable="true">ENIGMASIS</li>
        </ul>
    
        <li class="album14-tab" onclick="toggleAlbum(14)">※SINGLE ONLY</li>
        <ul class="album-content" id="album14">
            <li class="item album14" draggable="true">MIXED-UP</li>
            <li class="item album14" draggable="true">Revolve</li>
            <li class="item album14" draggable="true">PRIME</li>
            <li class="item album14" draggable="true">SHINE</li>
            <li class="item album14" draggable="true">SORA</li>
            <li class="item album14" draggable="true">僕に重なってくる今</li>
            <li class="item album14" draggable="true">=</li>
            <li class="item album14" draggable="true">EXTREAME</li>
            <li class="item album14" draggable="true">モノクローム</li>
            <li class="item album14" draggable="true">Rainy</li>
            <li class="item album14" draggable="true">凛句</li>
            <li class="item album14" draggable="true">志</li>
            <li class="item album14" draggable="true">over the stoic</li>
            <li class="item album14" draggable="true">体温</li>
            <li class="item album14" draggable="true">マダラ蝶</li>
            <li class="item album14" draggable="true">撃破</li>
            <li class="item album14" draggable="true">D-tecnoRize</li>
            <li class="item album14" draggable="true">MINORI</li>
            <li class="item album14" draggable="true">若さ故エンテレケイア</li>
            <li class="item album14" draggable="true">パニックワールド</li>
            <li class="item album14" draggable="true">魑魅魍魎マーチ</li>
            <li class="item album14" draggable="true">境地・マントラ</li>
            <li class="item album14" draggable="true">THE SONG</li>
            <li class="item album14" draggable="true">Massive</li>
            <li class="item album14" draggable="true">DEJAVU</li>
            <li class="item album14" draggable="true">LIFE</li>
            <li class="item album14" draggable="true">言わなくて伝わる　あれは少し嘘だ</li>
            <li class="item album14" draggable="true">DIS is TEKI</li>
            <li class="item album14" draggable="true">RANGE</li>
            <li class="item album14" draggable="true">PLOT</li>
            <li class="item album14" draggable="true">CORE STREAM</li>
            <li class="item album14" draggable="true">Forever Young</li>
            <li class="item album14" draggable="true">ONE LIFE</li>
            <li class="item album14" draggable="true">Spreadown</li>
            <li class="item album14" draggable="true">Teenage LOVE</li>
            <li class="item album14" draggable="true">LIVIN' IT UP</li>
            <li class="item album14" draggable="true">BVCK</li>
            <li class="item album14" draggable="true">Eye's Sentry</li>
            <li class="item album14" draggable="true">High Light!!</li>
            <li class="item album14" draggable="true">über cozy universe</li>
            <li class="item album14" draggable="true">MEMORIES of the End</li>
            <li class="item album14" draggable="true">PHOENIX</li>
            <li class="item album14" draggable="true">Countdown</li>
            <li class="item album14" draggable="true">MMH</li>
            <li class="item album14" draggable="true">WINGS ever</li>
        </ul>
    </ul>
    
</div>

<script>
let draggingItem = null;
let touchStartX = 0;
let touchStartY = 0;
let lastTapTime = 0;
let isDragging = false;
const maxSongs = 24;
const originalAlbumMap = new Map();

/**
 * ドラッグ＆ドロップを有効にする関数。
 * @param {Element} list - 有効にするリストの要素
 */
function enableDragAndDrop(list) {
    list.querySelectorAll(".item").forEach(item => {
        if (!originalAlbumMap.has(item)) {
            originalAlbumMap.set(item, list);
        }
        item.addEventListener("dragstart", (event) => {
            draggingItem = item;
            item.classList.add("dragging");
            event.dataTransfer.setData("text/plain", "");
        });
        item.addEventListener("dragend", finishDragging);
        item.addEventListener("touchstart", () => {
            draggingItem = item;
            item.classList.add("touchstart");
        });
        item.addEventListener("touchend", finishDragging);
    });
    list.addEventListener("dragover", handleDragOver);
    list.addEventListener("drop", handleDrop);
}

/**
 * ドラッグオーバー時の処理。
 * @param {DragEvent} event - ドラッグイベント
 */
function handleDragOver(event) {
    event.preventDefault();
    if (!draggingItem) return;
    const closestItem = getClosestItem(event.clientY);
    if (closestItem) {
        const bounding = closestItem.getBoundingClientRect();
        const offset = event.clientY - bounding.top;
        offset > bounding.height / 2 ? closestItem.after(draggingItem) : closestItem.before(draggingItem);
    }
}

/**
 * 指定されたY座標に最も近いアイテムを取得する。
 * @param {number} y - Y座標
 * @returns {Element} 最も近いアイテム
 */
function getClosestItem(y) {
    return [...setlist.children].reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        return offset < 0 && offset > closest.offset ? { offset, element: child } : closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

/**
 * ドロップ時の処理。
 * @param {DragEvent} event - ドラッグイベント
 */
function handleDrop(event) {
    event.preventDefault();
    if (!draggingItem) return;
    if (setlist.children.length < maxSongs) {
        const closestItem = getClosestItem(event.clientY);
        if (closestItem) {
            const bounding = closestItem.getBoundingClientRect();
            const offset = event.clientY - bounding.top;
            offset > bounding.height / 2 ? closestItem.after(draggingItem) : closestItem.before(draggingItem);
        } else {
            setlist.appendChild(draggingItem);
        }
    }
    finishDragging();
}

/**
 * ドラッグ終了時の処理。
 */
function finishDragging() {
    if (!draggingItem) return;
    draggingItem.classList.remove("dragging");
    draggingItem = null;
}

/**
 * アイテムを元のリストに戻す。
 * @param {Element} item - 元に戻すアイテム
 */
function restoreToOriginalList(item) {
    const originalList = originalAlbumMap.get(item);
    if (originalList) {
        // 元のリスト内での元の位置に要素を挿入
        const originalIndex = Array.from(originalList.children).findIndex(child => child.textContent === item.textContent);
        if (originalIndex !== -1) {
            originalList.insertBefore(item, originalList.children[originalIndex]);
        } else {
            originalList.appendChild(item);
        }

        // チェックボックスとラベルを削除
        const checkbox = item.querySelector("input[type='checkbox']");
        if (checkbox) {
            checkbox.remove();
        }
        const label = item.querySelector("span");
        if (label) {
            label.remove();
        }
    }
}

document.addEventListener("dblclick", (event) => {
    const item = event.target.closest(".item");
    if (!item) return;
    event.preventDefault();
    event.stopPropagation();
    if (!!event.target.closest("#setlist")) {
        // セットリストからハンバーガーメニューに戻す際に、元の要素を移動
        restoreToOriginalList(item);
    } else {
        // セットリストの一番下に追加
        if (setlist.children.length < maxSongs) {
            setlist.appendChild(item);

            // 曲名とチェックボックスを囲む要素を作成
            const songInfo = document.createElement("div");
            songInfo.classList.add("song-info");

            // 曲名をsongInfoに追加
            const songName = document.createTextNode(item.textContent);
            songInfo.appendChild(songName);

            // SEまたはトキノナミダの場合にチェックボックスを追加
            if (item.textContent.trim() === "SE" || item.textContent.trim() === "トキノナミダ") {
                const newCheckbox = document.createElement("input");
                newCheckbox.type = "checkbox";
                songInfo.appendChild(newCheckbox);

                // ラベルを追加
                const label = document.createElement("span");
                label.textContent = "(Short)";
                songInfo.appendChild(label);
            }

            // itemの内容をsongInfoで置き換える
            item.innerHTML = "";
            item.appendChild(songInfo);
            item.classList.add("setlist-item");

            // 曲名の余白に関するスタイルを追加
            songInfo.style.paddingLeft = "20px";
        }
    }
});

/**
 * メニューの開閉を切り替える。
 */
function toggleMenu() {
    document.getElementById("menu").classList.toggle("open");
    document.getElementById("menuButton").classList.toggle("open");
}

/**
 * アルバムの表示を切り替える。
 * @param {number} albumIndex - 切り替えるアルバムのインデックス
 */
function toggleAlbum(albumIndex) {
    document.querySelectorAll(".album-content").forEach(content => {
        content.id === "album" + albumIndex ? content.classList.toggle("active") : content.classList.remove("active");
    });
}

const setlist = document.getElementById("setlist");
if (setlist) enableDragAndDrop(setlist);
document.querySelectorAll(".album-content").forEach(enableDragAndDrop);

/**
 * セットリストの内容を取得する。
 * @returns {string[]} セットリストの曲リスト
 */
function getSetlist() {
    return Array.from(document.querySelectorAll(".setlist-item"))
        .map((item, index) => `${index + 1}. ${item.textContent.trim().replace("", "").trim()}`);
}

/**
 * セットリストを文字で共有する。
 */
function shareSetlistAsText() {
    const setlistItems = document.querySelectorAll("#setlist li");
    if (setlistItems.length === 0) {
        alert("セットリストに曲がありません！");
        return;
    }
    let songList = "\n" + Array.from(setlistItems).map(item => {
        const songName = item.querySelector(".song-info").childNodes[0].textContent.trim();
        const checkbox = item.querySelector("input[type='checkbox']");
        return checkbox && checkbox.checked ? " " + songName + " (Short)" : " " + songName;
    }).join("\n");
    navigator.share ? navigator.share({ title: "仮セトリ", text: songList }).catch(console.error) : alert("お使いのブラウザでは共有機能が利用できません。");
}

/**
 * セットリストの内容をURLパラメータにエンコードする。
 * @returns {string} URLパラメータ
 */
function encodeSetlist() {
    const setlistItems = document.querySelectorAll("#setlist li");
    const setlistArray = Array.from(setlistItems).map(item => {
        const songName = item.querySelector(".song-info").childNodes[0].textContent.trim();
        const checkbox = item.querySelector("input[type='checkbox']");
        return checkbox && checkbox.checked ? `${songName} (Short)` : songName;
    });
    return encodeURIComponent(setlistArray.join(","));
}

/**
 * URLパラメータからセットリストの内容をデコードする。
 * @param {string} params - URLパラメータ
 * @returns {string[]} セットリストの曲リスト
 */
function decodeSetlist(params) {
    return params ? decodeURIComponent(params).split(",") : [];
}

/**
 * セットリストをURLで共有する。
 */
function shareSetlistAsUrl() {
    const encodedSetlist = encodeSetlist();
    const shareUrl = `${window.location.origin}${window.location.pathname}?setlist=${encodedSetlist}`;
    navigator.share ? navigator.share({ title: "仮セトリ", url: shareUrl }).catch(console.error) : alert(`セットリストのURL: ${shareUrl}`);
}

/**
 * セットリストをURLパラメータから読み込む。
 */
function loadSetlistFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const setlistParams = urlParams.get("setlist");
    if (setlistParams) {
        const setlistArray = decodeSetlist(setlistParams);
        setlistArray.forEach(songName => {
            const newItem = document.createElement("li");
            newItem.classList.add("item", "setlist-item");
            newItem.draggable = true;

            const songInfo = document.createElement("div");
            songInfo.classList.add("song-info");

            const songText = document.createTextNode(songName.replace(" (Short)", ""));
            songInfo.appendChild(songText);

            if (songName.includes("(Short)")) {
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.checked = true;
                songInfo.appendChild(checkbox);

                const label = document.createElement("span");
                label.textContent = "(Short)";
                songInfo.appendChild(label);
            }

            newItem.appendChild(songInfo);
            setlist.appendChild(newItem);
        });

        enableDragAndDrop(setlist);

        // セットリストが変更されたときにURLパラメータを更新する
        setlist.addEventListener("change", (event) => {
            if (event.target.tagName === "INPUT" && event.target.type === "checkbox") {
                const encodedSetlist = encodeSetlist();
                history.replaceState(null, null, `?setlist=${encodedSetlist}`);
            }
        });

        // ダブルクリックイベントリスナーを設定
        setlist.addEventListener("dblclick", (event) => {
            const item = event.target.closest(".item");
            if (!item) return;
            event.preventDefault();
            event.stopPropagation();
            if (!!event.target.closest("#setlist")) {
                // セットリストからハンバーガーメニューに戻す際に、元の要素を移動
                restoreToOriginalList(item);
            }
        });
    }
}

// セットリストの子要素の変更を監視し、URLパラメータを更新する
const observer = new MutationObserver(() => {
    const encodedSetlist = encodeSetlist();
    history.replaceState(null, null, `?setlist=${encodedSetlist}`);
});

observer.observe(setlist, { childList: true, subtree: true });

// ページ読み込み時にセットリストをURLパラメータから読み込む
loadSetlistFromUrl();

// セットリストの内容が変更されたときにURLパラメータを更新する
setlist.addEventListener("change", (event) => {
    if (event.target.tagName === "INPUT" && event.target.type === "checkbox") {
        const encodedSetlist = encodeSetlist();
        history.replaceState(null, null, `?setlist=${encodedSetlist}`);
    }
});

// イベントリスナーの設定
document.querySelector(".send-all-button").addEventListener("click", shareSetlistAsText);
document.getElementById("shareSetlistButton").addEventListener("click", shareSetlistAsUrl);

function handleDrop(event) {
    event.preventDefault();
    if (!draggingItem) return;
    if (setlist.children.length < maxSongs) {
        const closestItem = getClosestItem(event.clientY);
        if (closestItem) {
            const bounding = closestItem.getBoundingClientRect();
            const offset = event.clientY - bounding.top;
            offset > bounding.height / 2 ? closestItem.after(draggingItem) : closestItem.before(draggingItem);
        } else {
            setlist.appendChild(draggingItem);
        }

        // 曲名とチェックボックスを囲む要素を作成
        const songInfo = document.createElement("div");
        songInfo.classList.add("song-info");

        // 曲名をsongInfoに追加
        const songName = document.createTextNode(draggingItem.textContent);
        songInfo.appendChild(songName);

        if (draggingItem.textContent.trim() === "トキノナミダ" || draggingItem.textContent.trim() === "SE") {
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            songInfo.appendChild(checkbox);

            // ラベルを追加
            const label = document.createElement("span");
            label.textContent = "(Short)";
            songInfo.appendChild(label);
        }

        // draggingItemの内容をsongInfoで置き換える
        draggingItem.innerHTML = "";
        draggingItem.appendChild(songInfo);
        draggingItem.classList.add("setlist-item");

        // 曲名の余白に関するスタイルを追加
        songInfo.style.paddingLeft = "20px";
    }
    finishDragging();
}

// セットリストとハンバーガーメニューの状態を保存する関数
function saveStateToStorage() {
    const setlistItems = document.querySelectorAll("#setlist li");
    const setlistArray = Array.from(setlistItems).map(item => {
        const songName = item.querySelector(".song-info").childNodes[0].textContent.trim();
        const checkbox = item.querySelector("input[type='checkbox']");
        return checkbox && checkbox.checked ? `${songName} (Short)` : songName;
    });

    const albumItems = document.querySelectorAll(".album-content .item");
    const albumArray = Array.from(albumItems).map(item => item.textContent.trim());

    const state = {
        setlist: setlistArray,
        album: albumArray,
    };

    // ローカルストレージに保存する場合
    localStorage.setItem("setlistState", JSON.stringify(state));

    // セッションストレージに保存する場合
    // sessionStorage.setItem("setlistState", JSON.stringify(state));
    console.log("saveStateToStorage() called"); // 追加
}

// ローカルストレージまたはセッションストレージから状態を復元する関数
function loadStateFromStorage() {
    // ローカルストレージから読み込む場合
    const storedState = localStorage.getItem("setlistState");

    // セッションストレージから読み込む場合
    // const storedState = sessionStorage.getItem("setlistState");

    if (storedState) {
        try { // 追加
            const state = JSON.parse(storedState);

            // セットリストの復元
            state.setlist.forEach(songName => {
                const newItem = document.createElement("li");
                newItem.classList.add("item", "setlist-item");
                newItem.draggable = true;

                const songInfo = document.createElement("div");
                songInfo.classList.add("song-info");

                const songText = document.createTextNode(songName.replace(" (Short)", ""));
                songInfo.appendChild(songText);

                if (songName.includes("(Short)")) {
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.checked = true;
                    songInfo.appendChild(checkbox);

                    const label = document.createElement("span");
                    label.textContent = "(Short)";
                    songInfo.appendChild(label);
                }

                newItem.appendChild(songInfo);
                setlist.appendChild(newItem);
            });

            // ハンバーガーメニューの復元
            state.album.forEach(songName => {
                const newItem = document.createElement("li");
                newItem.classList.add("item");
                newItem.draggable = true;
                newItem.textContent = songName;
                // ハンバーガーメニュー内の適切なリストに追加 (例: album1)
                const albumList = document.querySelector(".album-content ul"); // 修正
                if (albumList) {
                    albumList.appendChild(newItem);
                }
            });

            enableDragAndDrop(setlist);
            document.querySelectorAll(".album-content").forEach(enableDragAndDrop);

            // セットリストが変更されたときにストレージを更新する
            setlist.addEventListener("change", (event) => {
                if (event.target.tagName === "INPUT" && event.target.type === "checkbox") {
                    saveStateToStorage();
                }
            });

            // ダブルクリックイベントリスナーを設定
            setlist.addEventListener("dblclick", (event) => {
                const item = event.target.closest(".item");
                if (!item) return;
                event.preventDefault();
                event.stopPropagation();
                if (!!event.target.closest("#setlist")) {
                    // セットリストからハンバーガーメニューに戻す際に、元の要素を移動
                    restoreToOriginalList(item);
                }
            });
        } catch (error) { // 追加
            console.error("ローカルストレージからの復元に失敗しました:", error);
            // デフォルトの空のセットリストとハンバーガーメニューを表示 (必要に応じて)
        }
    } else {
        // ローカルストレージにデータがない場合、デフォルトの空のセットリストとハンバーガーメニューを表示 (必要に応じて)
    }
}

// ページ読み込み時に状態を復元する
loadStateFromStorage();

// セットリストの内容が変更されたときにストレージを更新する
setlist.addEventListener("change", () => {
    saveStateToStorage();
});

// ハンバーガーメニューの内容が変更されたときにストレージを更新する
document.querySelectorAll(".album-content").forEach(albumContent => {
    albumContent.addEventListener("change", () => {
        saveStateToStorage();
    });
});
    </script>  

    
    

    

</body>
</html>
